name: Deploy to VPS (gated + rotating backup)

on:
  workflow_run:
    workflows: ["Build (Next + Strapi)"]
    branches: [ main ]
    types: [ completed ]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    env:
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            set -euo pipefail

            echo "=== Deploy SHA ==="
            echo "${DEPLOY_SHA}"

            cd /var/www/health-template || exit 1

            echo "=== PRECHECKS ==="
            command -v pm2 >/dev/null 2>&1 || { echo "pm2 missing"; exit 1; }
            test -f next/.env.production.local || { echo "missing next/.env.production.local"; exit 1; }
            test -f strapi/.env.prod || test -f strapi/.env.production || test -f strapi/.env || echo "WARN: Strapi env file not found (check if you use PM2 env instead)"

            echo "=== ROTATING BACKUP (overwrite) ==="
            ts="$(date +%F_%H%M%S)"
            B="/root/backups/fullsite-latest"
            umask 077
            rm -rf "$B"
            mkdir -p "$B"
            echo "Backup dir: $B"

            {
              echo "DATE: $(date -Is)"
              echo "HOST: $(hostname)"
              echo
              echo "PM2 STATUS:"
              pm2 status || true
              echo
              echo "GIT STATUS:"
              git status -sb || true
              echo
              echo "LAST COMMITS:"
              git log --oneline -n 20 || true
            } > "$B/server_state.txt"

            tar -czf "$B/health-template_repo.tgz" \
              --exclude='**/node_modules' \
              --exclude='next/.next' \
              --exclude='**/.cache' \
              --exclude='**/.turbo' \
              --exclude='strapi/.tmp' \
              --exclude='strapi/public/uploads' \
              --exclude='strapi/data/*.tar.gz' \
              --exclude='**/.env*' \
              --exclude='**/*.bak*' \
              -C /var/www health-template

            DB_REAL="$(readlink -f strapi/.tmp/data.db 2>/dev/null || true)"
            if [ -n "${DB_REAL}" ] && [ -f "${DB_REAL}" ]; then
              cp -a "${DB_REAL}" "$B/strapi_data.db"
            else
              echo "WARN: Strapi DB not found at strapi/.tmp/data.db"
            fi

            if [ -d "strapi/public/uploads" ]; then
              tar -czf "$B/strapi_uploads.tgz" -C strapi/public uploads
            else
              echo "WARN: uploads folder not found"
            fi

            tar -czf "$B/nginx_config.tgz" \
              /etc/nginx/nginx.conf \
              /etc/nginx/sites-available \
              /etc/nginx/sites-enabled 2>/dev/null || true

            mkdir -p "$B/pm2"
            cp -a /root/.pm2/dump.pm2 "$B/pm2/" 2>/dev/null || true
            pm2 jlist > "$B/pm2/pm2_jlist.json" 2>/dev/null || true

            (cd "$B" && sha256sum * 2>/dev/null > SHA256SUMS.txt || true)
            echo "Backup done: $(du -sh "$B" || true)"

            echo "=== DEPLOY CODE (exact SHA) ==="
            git fetch --all --prune
            git reset --hard "${DEPLOY_SHA}"

            echo "=== BUILD NEXT ==="
            cd next
            npm ci
            npm run build

            echo "=== BUILD STRAPI ==="
            cd ../strapi
            npm ci
            npm run build

            echo "=== RESTART (only after successful builds) ==="
            pm2 restart next
            pm2 restart strapi
            pm2 save || true

            echo "=== SMOKE CHECK ==="
            curl -fsS -I https://theplacestudio.hu/ | head -n 12 || exit 1
            curl -fsS -I https://theplacestudio.hu/api/privacy-policy | head -n 12 || exit 1

            echo "DEPLOY DONE âœ…"
