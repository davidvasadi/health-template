name: Deploy to VPS (gated + fast + safe rollback)

on:
  workflow_run:
    workflows: ["Build (Next + Strapi)"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    env:
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_SHA: ${{ env.DEPLOY_SHA }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DEPLOY_SHA
          script_stop: true
          command_timeout: 60m
          script: |
            set -euo pipefail

            echo "=== Deploy SHA ==="
            echo "$DEPLOY_SHA"
            [ -n "$DEPLOY_SHA" ] || { echo "ERROR: DEPLOY_SHA is empty"; exit 1; }

            cd /var/www/health-template || exit 1
            git rev-parse --is-inside-work-tree >/dev/null

            echo "=== PRECHECKS ==="
            command -v pm2 >/dev/null 2>&1 || { echo "pm2 missing"; exit 1; }
            test -f next/.env.production.local || { echo "missing next/.env.production.local"; exit 1; }

            echo "=== FETCH ==="
            OLD_SHA="$(git rev-parse HEAD 2>/dev/null || true)"
            git fetch --all --prune

            if [ -n "$OLD_SHA" ] && [ "$OLD_SHA" = "$DEPLOY_SHA" ]; then
              echo "No change (OLD_SHA == DEPLOY_SHA). Exiting."
              exit 0
            fi

            NEED_NEXT=1
            NEED_STRAPI=1

            if [ -n "$OLD_SHA" ]; then
              CHANGED="$(git diff --name-only "$OLD_SHA" "$DEPLOY_SHA" || true)"
              echo "=== CHANGED FILES (short) ==="
              printf "%s\n" "$CHANGED" | head -n 200 || true

              NEED_NEXT=0
              NEED_STRAPI=0
              printf "%s\n" "$CHANGED" | grep -qE '^next/'  && NEED_NEXT=1 || true
              printf "%s\n" "$CHANGED" | grep -qE '^strapi/' && NEED_STRAPI=1 || true
            fi

            echo "NEED_NEXT=$NEED_NEXT NEED_STRAPI=$NEED_STRAPI"

            if [ "$NEED_NEXT" -eq 0 ] && [ "$NEED_STRAPI" -eq 0 ]; then
              echo "No next/strapi changes -> skipping deploy."
              exit 0
            fi

            rollback() {
              echo "=== ROLLBACK to OLD_SHA: $OLD_SHA ==="
              [ -n "${OLD_SHA:-}" ] || { echo "No OLD_SHA to rollback to"; return 1; }
              git reset --hard "$OLD_SHA" || return 1

              # build csak amit piszkáltunk
              if [ "$NEED_NEXT" -eq 1 ]; then
                cd /var/www/health-template/next
                npm run build || true
              fi
              if [ "$NEED_STRAPI" -eq 1 ]; then
                cd /var/www/health-template/strapi
                npm run build || true
              fi

              if [ "$NEED_NEXT" -eq 1 ]; then pm2 restart next --update-env || true; fi
              if [ "$NEED_STRAPI" -eq 1 ]; then pm2 restart strapi --update-env || true; fi
              pm2 save || true
              echo "ROLLBACK DONE ✅"
            }

            echo "=== FIXED BACKUP (best-effort, never fails deploy) ==="
            (
              set +e
              B="/root/backups/fullsite-latest"
              umask 077
              mkdir -p "$B"

              # ne nőjön: fixed dir takarítás
              rm -rf "$B/pm2" "$B/uploads" 2>/dev/null
              rm -f "$B/server_state.txt" "$B/strapi_data.db" "$B/nginx_config.tgz" 2>/dev/null
              mkdir -p "$B/pm2"

              {
                echo "DATE: $(date -Is)"
                echo "HOST: $(hostname)"
                echo
                echo "PM2 STATUS:"
                pm2 status || true
                echo
                echo "GIT STATUS:"
                git status -sb || true
                echo
                echo "LAST COMMITS:"
                git log --oneline -n 20 || true
              } > "$B/server_state.txt" || true

              DB_REAL="$(readlink -f strapi/.tmp/data.db 2>/dev/null || true)"
              if [ -n "${DB_REAL}" ] && [ -f "${DB_REAL}" ]; then
                if command -v sqlite3 >/dev/null 2>&1; then
                  sqlite3 "${DB_REAL}" ".backup '${B}/strapi_data.db'" || true
                fi
                [ -f "${B}/strapi_data.db" ] || cp -a "${DB_REAL}" "${B}/strapi_data.db" || true
                echo "✅ DB backup -> $B/strapi_data.db"
              else
                echo "WARN: Strapi DB not found (strapi/.tmp/data.db)"
              fi

              if [ "$NEED_STRAPI" -eq 1 ] && [ -d "strapi/public/uploads" ]; then
                if command -v rsync >/dev/null 2>&1; then
                  mkdir -p "$B/uploads"
                  rsync -a --delete "strapi/public/uploads/" "$B/uploads/" || true
                  echo "✅ uploads mirror -> $B/uploads"
                else
                  echo "WARN: rsync missing, skipping uploads mirror"
                fi
              else
                echo "uploads backup skipped (no strapi deploy)"
              fi

              tar -czf "$B/nginx_config.tgz" \
                /etc/nginx/nginx.conf \
                /etc/nginx/sites-available \
                /etc/nginx/sites-enabled 2>/dev/null || true

              cp -a /root/.pm2/dump.pm2 "$B/pm2/" 2>/dev/null || true
              pm2 jlist > "$B/pm2/pm2_jlist.json" 2>/dev/null || true

              echo "Backup done: $(du -sh "$B" 2>/dev/null || true)"
              exit 0
            ) || true

            echo "=== DEPLOY CODE (exact SHA) ==="
            git reset --hard "$DEPLOY_SHA"

            install_if_needed() {
              APPDIR="$1"
              cd "/var/www/health-template/$APPDIR"

              LOCK="package-lock.json"
              HASH_DIR="/var/www/health-template/.ci"
              HASH_FILE="${HASH_DIR}/${APPDIR}_lock_hash"
              mkdir -p "$HASH_DIR"

              if [ ! -f "$LOCK" ]; then
                echo "WARN: $APPDIR/$LOCK missing -> npm ci"
                npm ci --no-audit --no-fund
                return 0
              fi

              CUR_HASH="$(sha256sum "$LOCK" | awk '{print $1}')"
              OLD_HASH=""
              [ -f "$HASH_FILE" ] && OLD_HASH="$(cat "$HASH_FILE" || true)"

              if [ -d node_modules ] && [ -n "$OLD_HASH" ] && [ "$CUR_HASH" = "$OLD_HASH" ]; then
                echo "✅ $APPDIR deps unchanged -> skip npm ci"
              else
                echo "→ $APPDIR deps changed/missing -> npm ci"
                npm ci --no-audit --no-fund
                echo "$CUR_HASH" > "$HASH_FILE"
              fi
            }

            if [ "$NEED_NEXT" -eq 1 ]; then
              echo "=== BUILD NEXT ==="
              install_if_needed "next"
              cd /var/www/health-template/next
              npm run build
            else
              echo "=== SKIP NEXT (no next/ changes) ==="
            fi

            if [ "$NEED_STRAPI" -eq 1 ]; then
              echo "=== BUILD STRAPI ==="
              install_if_needed "strapi"
              cd /var/www/health-template/strapi
              npm run build
            else
              echo "=== SKIP STRAPI (no strapi/ changes) ==="
            fi

            echo "=== RESTART (only what changed) ==="
            if [ "$NEED_NEXT" -eq 1 ]; then pm2 restart next --update-env; fi
            if [ "$NEED_STRAPI" -eq 1 ]; then pm2 restart strapi --update-env; fi
            pm2 save || true

            echo "=== SMOKE CHECK ==="
            # Next: /hu (ne 308)
            home_code="$(curl -sS -o /dev/null -w "%{http_code}" -L https://theplacestudio.hu/hu || true)"
            echo "HOME code=$home_code"
            if [ "$home_code" -lt 200 ] || [ "$home_code" -ge 500 ]; then
              echo "SMOKE FAIL: home"
              rollback || true
              exit 1
            fi

            # Strapi: retry
            ok=0
            for i in $(seq 1 20); do
              code="$(curl -sS -o /dev/null -w "%{http_code}" https://theplacestudio.hu/api/global || true)"
              echo "API code=$code (try $i)"
              if [ "$code" -ge 200 ] && [ "$code" -lt 500 ]; then ok=1; break; fi
              sleep 2
            done

            if [ "$ok" -ne 1 ]; then
              echo "SMOKE FAIL: api"
              rollback || true
              exit 1
            fi

            echo "DEPLOY DONE ✅"
