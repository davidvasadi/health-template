name: Deploy to VPS (gated + fast + fixed backup)

on:
  workflow_run:
    workflows: ["Build (Next + Strapi)"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    env:
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_SHA: ${{ env.DEPLOY_SHA }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DEPLOY_SHA
          script_stop: true
          script: |
            set -euo pipefail

            echo "=== Deploy SHA ==="
            echo "$DEPLOY_SHA"
            [ -n "$DEPLOY_SHA" ] || { echo "ERROR: DEPLOY_SHA is empty"; exit 1; }

            cd /var/www/health-template || exit 1

            echo "=== PRECHECKS ==="
            command -v pm2 >/dev/null 2>&1 || { echo "pm2 missing"; exit 1; }
            test -f next/.env.production.local || { echo "missing next/.env.production.local"; exit 1; }

            echo "=== CALC CHANGES (before any backup) ==="
            OLD_SHA="$(git rev-parse HEAD 2>/dev/null || true)"
            git fetch --all --prune

            if [ -n "$OLD_SHA" ] && [ "$OLD_SHA" = "$DEPLOY_SHA" ]; then
              echo "No change (OLD_SHA == DEPLOY_SHA). Exiting."
              exit 0
            fi

            NEED_NEXT=1
            NEED_STRAPI=1

            if [ -n "$OLD_SHA" ]; then
              CHANGED="$(git diff --name-only "$OLD_SHA" "$DEPLOY_SHA" || true)"
              echo "=== CHANGED FILES (short) ==="
              printf "%s\n" "$CHANGED" | head -n 200 || true

              NEED_NEXT=0
              NEED_STRAPI=0
              printf "%s\n" "$CHANGED" | grep -qE '^next/'  && NEED_NEXT=1 || true
              printf "%s\n" "$CHANGED" | grep -qE '^strapi/' && NEED_STRAPI=1 || true
            fi

            echo "NEED_NEXT=$NEED_NEXT NEED_STRAPI=$NEED_STRAPI"

            # ✅ ha csak workflow/docs változott, ne csináljon semmit (ettől lett most piros)
            if [ "$NEED_NEXT" -eq 0 ] && [ "$NEED_STRAPI" -eq 0 ]; then
              echo "No next/strapi changes -> skipping backup/build/restart/smoke."
              exit 0
            fi

            echo "=== FIXED BACKUP (overwrite in-place) ==="
            B="/root/backups/fullsite-latest"
            umask 077
            mkdir -p "$B"
            echo "Backup dir: $B"

            {
              echo "DATE: $(date -Is)"
              echo "HOST: $(hostname)"
              echo
              echo "PM2 STATUS:"
              pm2 status || true
              echo
              echo "GIT STATUS:"
              git status -sb || true
              echo
              echo "LAST COMMITS:"
              git log --oneline -n 20 || true
            } > "$B/server_state.txt"

            # --- DB backup (sqlite) ---
            DB_REAL="$(readlink -f strapi/.tmp/data.db 2>/dev/null || true)"
            if [ -n "${DB_REAL}" ] && [ -f "${DB_REAL}" ]; then
              if command -v sqlite3 >/dev/null 2>&1; then
                sqlite3 "${DB_REAL}" ".backup '${B}/strapi_data.db'" || cp -a "${DB_REAL}" "${B}/strapi_data.db"
              else
                cp -a "${DB_REAL}" "${B}/strapi_data.db"
              fi
              echo "✅ DB backup -> $B/strapi_data.db"
            else
              echo "WARN: Strapi DB not found at strapi/.tmp/data.db"
            fi

            # uploads backup csak akkor, ha strapi deploy lesz (különben lassít feleslegesen)
            if [ "$NEED_STRAPI" -eq 1 ] && [ -d "strapi/public/uploads" ]; then
              mkdir -p "$B/uploads"
              rsync -a --delete "strapi/public/uploads/" "$B/uploads/"
              echo "✅ uploads mirror -> $B/uploads (rsync --delete)"
            else
              echo "uploads backup skipped (no strapi deploy)"
            fi

            tar -czf "$B/nginx_config.tgz" \
              /etc/nginx/nginx.conf \
              /etc/nginx/sites-available \
              /etc/nginx/sites-enabled 2>/dev/null || true

            mkdir -p "$B/pm2"
            cp -a /root/.pm2/dump.pm2 "$B/pm2/" 2>/dev/null || true
            pm2 jlist > "$B/pm2/pm2_jlist.json" 2>/dev/null || true

            echo "Backup done: $(du -sh "$B" || true)"

            echo "=== DEPLOY CODE (exact SHA) ==="
            git reset --hard "$DEPLOY_SHA"

            install_if_needed() {
              APPDIR="$1"
              cd "/var/www/health-template/$APPDIR"
              LOCK="package-lock.json"
              HASH_FILE="node_modules/.ci_lock_hash"

              if [ ! -f "$LOCK" ]; then
                echo "WARN: $APPDIR/$LOCK missing -> npm ci"
                npm ci
                return 0
              fi

              CUR_HASH="$(sha256sum "$LOCK" | awk '{print $1}')"
              OLD_HASH=""
              [ -f "$HASH_FILE" ] && OLD_HASH="$(cat "$HASH_FILE" || true)"

              if [ -d node_modules ] && [ -n "$OLD_HASH" ] && [ "$CUR_HASH" = "$OLD_HASH" ]; then
                echo "✅ $APPDIR deps unchanged -> skip npm ci"
              else
                echo "→ $APPDIR deps changed/missing -> npm ci"
                npm ci
                mkdir -p node_modules
                echo "$CUR_HASH" > "$HASH_FILE"
              fi
            }

            if [ "$NEED_NEXT" -eq 1 ]; then
              echo "=== BUILD NEXT ==="
              install_if_needed "next"
              cd /var/www/health-template/next
              npm run build
            else
              echo "=== SKIP NEXT (no next/ changes) ==="
            fi

            if [ "$NEED_STRAPI" -eq 1 ]; then
              echo "=== BUILD STRAPI ==="
              install_if_needed "strapi"
              cd /var/www/health-template/strapi
              npm run build
            else
              echo "=== SKIP STRAPI (no strapi/ changes) ==="
            fi

            echo "=== RESTART (only what changed) ==="
            if [ "$NEED_NEXT" -eq 1 ]; then pm2 restart next --update-env; fi
            if [ "$NEED_STRAPI" -eq 1 ]; then pm2 restart strapi --update-env; fi
            pm2 save || true

            echo "=== SMOKE CHECK (no pipes) ==="
            curl -fsS -I -L https://theplacestudio.hu/hu > /tmp/smoke_home.txt
            head -n 12 /tmp/smoke_home.txt || true

            for i in $(seq 1 20); do
              code="$(curl -sS -o /dev/null -w "%{http_code}" https://theplacestudio.hu/api/global || true)"
              echo "API code=$code (try $i)"
              [ "$code" != "000" ] && [ "$code" -lt 500 ] && break
              sleep 3
            done
            curl -fsS -I https://theplacestudio.hu/api/global > /tmp/smoke_api.txt
            head -n 12 /tmp/smoke_api.txt || true

            echo "DEPLOY DONE ✅"
