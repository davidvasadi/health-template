# Ez a workflow neve, így fogod látni a GitHub Actions / Actions fülön
name: Build & Deploy (Next + Strapi)

# Mikor induljon el?
on:
  push:
    branches: [ main ]   # csak akkor fut, ha a main ágra pusholsz

jobs:
  # -----------------------------
  # 1) NEXT.JS build ellenőrzése
  # -----------------------------
  next-build:
    runs-on: ubuntu-latest    # GitHub ad egy friss Ubuntu VM-et
    defaults:
      run:
        working-directory: next  # minden parancsot a /next mappában futtat
    steps:
      - uses: actions/checkout@v4   # lehúzza a teljes repót
      - uses: actions/setup-node@v4 # felrakja a Node.js környezetet
        with:
          node-version: '20'        # Node.js 20-at használunk
          cache: 'npm'              # npm cache-t bekapcsoljuk (gyorsabb lesz)
          cache-dependency-path: next/package-lock.json
      - run: npm ci                 # tiszta install (package-lock alapján)
      - run: npm run build          # buildeli a Next appot

  # -----------------------------
  # 2) STRAPI build ellenőrzése
  # -----------------------------
  strapi-build:
    runs-on: ubuntu-latest
    needs: next-build               # csak akkor indul, ha a Next sikeresen lebuildelt
    defaults:
      run:
        working-directory: strapi   # itt már a /strapi mappában dolgozunk
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: strapi/package-lock.json
      - run: npm ci
      - run: npm run build          # buildeli a Strapi admin panelt

  # -----------------------------
  # 3) DEPLOY lépés a VPS-re
  # -----------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: [next-build, strapi-build] # csak akkor fut le, ha mindkét build sikeres volt
    steps:
      - name: Checkout
        uses: actions/checkout@v4    # nem feltétlen kellene, de biztonság kedvéért behúzza a repót

      - name: Copy project to VPS
        uses: appleboy/ssh-action@v1.0.3   # SSH kapcsolódás a VPS-re
        with:
          host: ${{ secrets.VPS_HOST }}    # GitHub Secrets -> VPS hostnév / IP
          username: ${{ secrets.VPS_USER }}# VPS felhasználónév (pl. ubuntu / dave)
          key: ${{ secrets.VPS_KEY }}      # SSH privát kulcs (titkosítva, soha ne a repóban!)
          script: |                        # a távoli szerveren futtatott parancsok
            cd /var/www/health-template || exit 1  # odalépünk a project mappába (léteznie kell)

            echo "→ Pull latest code"
            git reset --hard               # minden lokális módosítást törlünk
            git pull origin main           # lehúzzuk a friss kódot a main ágról

            echo "→ Build Next"
            cd next
            npm ci                         # újratelepíti a dependenciákat
            npm run build                  # buildeli a Next-et

            echo "→ Build Strapi"
            cd ../strapi
            npm ci
            npm run build                  # buildeli a Strapi admin panelt

            echo "→ Restart services"
            # újraindítjuk a pm2 alatti procikat
            pm2 restart all || pm2 start npm --name "next" -- run start
