name: Deploy to VPS (gated + fast + safe)

on:
  workflow_run:
    workflows: ["Build (Next + Strapi)"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    # Csak akkor fusson, ha:
    # - kézzel indítod (workflow_dispatch), VAGY
    # - a Build workflow sikeres volt (workflow_run + success)
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    timeout-minutes: 70
    env:
      # workflow_run esetén a Build head_sha-ja, különben fallback github.sha
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Debug trigger
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"
          echo "deploy_sha=${{ env.DEPLOY_SHA }}"
          echo "workflow_run_conclusion=${{ github.event.workflow_run.conclusion }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_SHA: ${{ env.DEPLOY_SHA }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          envs: DEPLOY_SHA
          script_stop: true
          command_timeout: 60m
          script: |
            # Force bash-ish behavior (ssh-action usually uses sh; this guard ensures we fail fast)
            if [ -z "${BASH_VERSION:-}" ]; then
              echo "INFO: switching to bash..."
              exec bash -lc "$0" "$@"
            fi

            set -Eeuo pipefail

            STAGE="init"
            log(){ printf '[%s] [%s] %s\n' "$(date -Is)" "$STAGE" "$*"; }
            die(){ log "❌ ERROR: $*"; exit 1; }

            on_err(){
              local ec=$?
              local line=${BASH_LINENO[0]:-?}
              log "❌ FAIL (exit=$ec) at line $line: ${BASH_COMMAND}"
              exit "$ec"
            }
            trap on_err ERR

            run_capture() {
              local name="$1"; shift
              local f="/tmp/deploy_${DEPLOY_SHA}_${name}.log"

              log "RUN: $name"
              set +e
              "$@" >"$f" 2>&1
              local rc=$?
              set -e

              if [ "$rc" -ne 0 ]; then
                log "❌ $name failed rc=$rc — last 200 lines:"
                tail -n 200 "$f" || true

                log "npm debug log tail (if exists):"
                local npm_log
                npm_log="$(ls -t /root/.npm/_logs/* 2>/dev/null | head -n 1 || true)"
                [ -n "$npm_log" ] && tail -n 200 "$npm_log" || true

                die "$name failed"
              fi

              log "✅ $name OK"
              return 0
            }

            REPO="/var/www/health-template"
            DOMAIN="https://theplacestudio.hu"
            LOCK_FILE="/var/lock/health-template-deploy.lock"

            BUILD_DIR=""
            cleanup_worktree(){
              # best-effort cleanup; NEVER fail deploy
              set +e
              if [ -n "${BUILD_DIR:-}" ] && [ -d "${BUILD_DIR:-}" ]; then
                ( cd "$REPO" && git worktree remove --force "$BUILD_DIR" >/dev/null 2>&1 ) || true
                ( cd "$REPO" && git worktree prune >/dev/null 2>&1 ) || true
              fi
              set -e
              return 0
            }

            on_exit(){
              local rc=$?
              local last="$STAGE"
              STAGE="exit"
              log "EXIT rc=$rc (last_stage=$last)"
              cleanup_worktree || true
              # IMPORTANT: no 'exit' here -> no silent status flip
              return 0
            }
            trap on_exit EXIT

            log "=== Deploy SHA === ${DEPLOY_SHA:-}"
            [ -n "${DEPLOY_SHA:-}" ] || die "DEPLOY_SHA is empty"

            STAGE="lock"
            command -v flock >/dev/null 2>&1 || die "flock missing (install util-linux)"
            exec 9>"$LOCK_FILE"
            if ! flock -n 9; then
              log "Another deploy is running -> exit 0"
              exit 0
            fi

            STAGE="prechecks"
            command -v pm2  >/dev/null 2>&1 || die "pm2 missing"
            command -v git  >/dev/null 2>&1 || die "git missing"
            command -v curl >/dev/null 2>&1 || die "curl missing"
            command -v node >/dev/null 2>&1 || die "node missing"
            command -v npm  >/dev/null 2>&1 || die "npm missing"

            cd "$REPO" || die "Cannot cd $REPO"
            git rev-parse --is-inside-work-tree >/dev/null 2>&1 || die "Not a git repo: $REPO"

            if ! git diff --quiet || ! git diff --cached --quiet; then
              die "Working tree is dirty (uncommitted changes). Abort."
            fi

            STAGE="fetch"
            OLD_SHA="$(git rev-parse HEAD 2>/dev/null || true)"
            log "OLD_SHA=$OLD_SHA"
            git fetch --all --prune
            git cat-file -e "$DEPLOY_SHA^{commit}" 2>/dev/null || die "DEPLOY_SHA not found in repo objects"

            if [ -n "$OLD_SHA" ] && [ "$OLD_SHA" = "$DEPLOY_SHA" ]; then
              log "No change (OLD_SHA == DEPLOY_SHA). Exiting."
              exit 0
            fi

            STAGE="detect-changes"
            NEED_NEXT=1
            NEED_STRAPI=1
            LOCK_NEXT_CHANGED=1
            LOCK_STRAPI_CHANGED=1

            if [ -n "$OLD_SHA" ]; then
              CHANGED="$(git diff --name-only "$OLD_SHA" "$DEPLOY_SHA" || true)"
              log "Changed files (head 200):"
              printf "%s\n" "$CHANGED" | head -n 200 || true

              NEED_NEXT=0
              NEED_STRAPI=0
              printf "%s\n" "$CHANGED" | grep -qE '^next/'  && NEED_NEXT=1 || true
              printf "%s\n" "$CHANGED" | grep -qE '^strapi/' && NEED_STRAPI=1 || true

              LOCK_NEXT_CHANGED=0
              LOCK_STRAPI_CHANGED=0
              git diff --name-only "$OLD_SHA" "$DEPLOY_SHA" -- next/package-lock.json   | grep -q . && LOCK_NEXT_CHANGED=1 || true
              git diff --name-only "$OLD_SHA" "$DEPLOY_SHA" -- strapi/package-lock.json | grep -q . && LOCK_STRAPI_CHANGED=1 || true
            fi

            log "NEED_NEXT=$NEED_NEXT NEED_STRAPI=$NEED_STRAPI"
            log "LOCK_NEXT_CHANGED=$LOCK_NEXT_CHANGED LOCK_STRAPI_CHANGED=$LOCK_STRAPI_CHANGED"

            if [ "$NEED_NEXT" -eq 0 ] && [ "$NEED_STRAPI" -eq 0 ]; then
              log "No next/strapi changes -> skipping deploy."
              exit 0
            fi

            STAGE="backup"
            (
              set +e
              B="/root/backups/fullsite-latest"
              umask 077
              mkdir -p "$B" "$B/pm2"
              rm -rf "$B/pm2" "$B/uploads" 2>/dev/null
              rm -f "$B/server_state.txt" "$B/strapi_data.db" "$B/nginx_config.tgz" 2>/dev/null
              mkdir -p "$B/pm2"

              {
                echo "DATE: $(date -Is)"
                echo "HOST: $(hostname)"
                echo
                echo "PM2 STATUS:"
                pm2 status || true
                echo
                echo "GIT STATUS:"
                git status -sb || true
                echo
                echo "LAST COMMITS:"
                git log --oneline -n 20 || true
              } > "$B/server_state.txt" || true

              DB_REAL="$(readlink -f strapi/.tmp/data.db 2>/dev/null || true)"
              if [ -n "${DB_REAL}" ] && [ -f "${DB_REAL}" ]; then
                if command -v sqlite3 >/dev/null 2>&1; then
                  sqlite3 "${DB_REAL}" ".backup '${B}/strapi_data.db'" || true
                fi
                [ -f "${B}/strapi_data.db" ] || cp -a "${DB_REAL}" "${B}/strapi_data.db" || true
              fi

              tar -czf "$B/nginx_config.tgz" \
                /etc/nginx/nginx.conf \
                /etc/nginx/sites-available \
                /etc/nginx/sites-enabled 2>/dev/null || true

              cp -a /root/.pm2/dump.pm2 "$B/pm2/" 2>/dev/null || true
              pm2 jlist > "$B/pm2/pm2_jlist.json" 2>/dev/null || true
              echo "Backup size: $(du -sh "$B" 2>/dev/null || echo n/a)"
              exit 0
            ) || true

            STAGE="staging-build"
            DEPLOY_ROOT="$REPO/.deploy"
            BUILD_DIR="$DEPLOY_ROOT/build-$DEPLOY_SHA"
            mkdir -p "$DEPLOY_ROOT"
            rm -rf "$BUILD_DIR" 2>/dev/null || true

            git worktree add --detach "$BUILD_DIR" "$DEPLOY_SHA" >/dev/null

            # env copy
            if [ -f "$REPO/next/.env.production.local" ]; then
              cp -a "$REPO/next/.env.production.local" "$BUILD_DIR/next/.env.production.local"
            fi
            if [ -f "$REPO/strapi/.env" ]; then
              cp -a "$REPO/strapi/.env" "$BUILD_DIR/strapi/.env" || true
            fi

            # deps strategy:
            # - ha lock nem változott és van live node_modules -> symlink (gyors, biztonságos)
            # - ha lock változott / nincs live nm -> npm ci a build dirben, és később node_modules swap
            SWAP_NEXT_NM=0
            SWAP_STRAPI_NM=0

            if [ "$NEED_NEXT" -eq 1 ]; then
              STAGE="deps-next"
              if [ "$LOCK_NEXT_CHANGED" -eq 0 ] && [ -d "$REPO/next/node_modules" ]; then
                ln -s "$REPO/next/node_modules" "$BUILD_DIR/next/node_modules"
                log "deps next: symlink live node_modules"
              else
                SWAP_NEXT_NM=1
                run_capture "next_npm_ci" bash -lc "cd '$BUILD_DIR/next' && npm ci --no-audit --no-fund"
              fi

              STAGE="build-next"
              run_capture "next_build" bash -lc "cd '$BUILD_DIR/next' && npm run build"
            fi

            if [ "$NEED_STRAPI" -eq 1 ]; then
              STAGE="deps-strapi"
              if [ "$LOCK_STRAPI_CHANGED" -eq 0 ] && [ -d "$REPO/strapi/node_modules" ]; then
                ln -s "$REPO/strapi/node_modules" "$BUILD_DIR/strapi/node_modules"
                log "deps strapi: symlink live node_modules"
              else
                SWAP_STRAPI_NM=1
                run_capture "strapi_npm_ci" bash -lc "cd '$BUILD_DIR/strapi' && npm ci --no-audit --no-fund"
              fi

              STAGE="build-strapi"
              run_capture "strapi_build" bash -lc "cd '$BUILD_DIR/strapi' && npm run build"
            fi

            # STOP ONLY NOW (build already done -> prod didn't stop during build)
            STAGE="stop-procs"
            if [ "$NEED_NEXT" -eq 1 ]; then pm2 stop next || true; fi
            if [ "$NEED_STRAPI" -eq 1 ]; then pm2 stop strapi || true; fi

            STAGE="apply-live-code"
            cd "$REPO"
            git reset --hard "$DEPLOY_SHA"
            log "LIVE HEAD NOW: $(git rev-parse HEAD)"
            log "LIVE COMMIT: $(git show -s --oneline HEAD)"

            swap_mv(){
              local target="$1"
              local source="$2"
              local prev="${target}.prev"
              rm -rf "$prev" 2>/dev/null || true
              if [ -e "$target" ]; then
                mv "$target" "$prev"
              fi
              mv "$source" "$target"
            }

            STAGE="swap-artifacts"
            if [ "$NEED_NEXT" -eq 1 ]; then
              swap_mv "$REPO/next/.next" "$BUILD_DIR/next/.next"
              if [ "$SWAP_NEXT_NM" -eq 1 ] && [ -d "$BUILD_DIR/next/node_modules" ]; then
                swap_mv "$REPO/next/node_modules" "$BUILD_DIR/next/node_modules"
              fi
            fi

            if [ "$NEED_STRAPI" -eq 1 ]; then
              swap_mv "$REPO/strapi/dist" "$BUILD_DIR/strapi/dist"
              if [ "$SWAP_STRAPI_NM" -eq 1 ] && [ -d "$BUILD_DIR/strapi/node_modules" ]; then
                swap_mv "$REPO/strapi/node_modules" "$BUILD_DIR/strapi/node_modules"
              fi
            fi

            STAGE="restart"
            if [ "$NEED_NEXT" -eq 1 ]; then pm2 restart next --update-env; fi
            if [ "$NEED_STRAPI" -eq 1 ]; then pm2 restart strapi --update-env; fi
            pm2 save || true

            STAGE="smoke"
            check_url(){
              local url="$1"
              local name="$2"
              local tries="${3:-15}"
              local ok=0
              for i in $(seq 1 "$tries"); do
                code="$(curl -sS -o /dev/null -w "%{http_code}" -L --connect-timeout 5 --max-time 15 "$url" || echo 000)"
                log "$name code=$code (try $i)"
                if [ "$code" -ge 200 ] && [ "$code" -lt 400 ]; then ok=1; break; fi
                sleep 2
              done
              [ "$ok" -eq 1 ] || return 1
              return 0
            }

            rollback(){
              STAGE="rollback"
              log "=== ROLLBACK to OLD_SHA=$OLD_SHA ==="
              [ -n "${OLD_SHA:-}" ] || { log "No OLD_SHA -> cannot rollback"; return 1; }

              pm2 stop next || true
              pm2 stop strapi || true

              if [ -d "$REPO/next/.next.prev" ]; then
                rm -rf "$REPO/next/.next" 2>/dev/null || true
                mv "$REPO/next/.next.prev" "$REPO/next/.next" || true
              fi
              if [ -d "$REPO/next/node_modules.prev" ]; then
                rm -rf "$REPO/next/node_modules" 2>/dev/null || true
                mv "$REPO/next/node_modules.prev" "$REPO/next/node_modules" || true
              fi

              if [ -d "$REPO/strapi/dist.prev" ]; then
                rm -rf "$REPO/strapi/dist" 2>/dev/null || true
                mv "$REPO/strapi/dist.prev" "$REPO/strapi/dist" || true
              fi
              if [ -d "$REPO/strapi/node_modules.prev" ]; then
                rm -rf "$REPO/strapi/node_modules" 2>/dev/null || true
                mv "$REPO/strapi/node_modules.prev" "$REPO/strapi/node_modules" || true
              fi

              git reset --hard "$OLD_SHA" || true
              pm2 restart next --update-env || true
              pm2 restart strapi --update-env || true
              pm2 save || true
              log "ROLLBACK DONE ✅"
            }

            check_url "$DOMAIN/hu" "HOME" 10 || { log "SMOKE FAIL: home"; rollback || true; exit 1; }
            check_url "$DOMAIN/api/global" "API(global)" 20 || { log "SMOKE FAIL: api/global"; rollback || true; exit 1; }

            log "DEPLOY DONE ✅"
            exit 0
